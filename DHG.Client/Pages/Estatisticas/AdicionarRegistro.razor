@page "/adicionar-registro"
@using DHG.Client.Services
@using DHG.Client.ViewModel

<h3>Novo Registro de Humor e Gatilhos</h3>
<hr />

@if (mostrarSucesso)
{
    <div class="alert alert-success" role="alert">
        ✅ Registro salvo com sucesso!
        <button class="btn btn-sm btn-link" @onclick="RedirecionarParaEstatisticas">Ver Estatísticas</button>
    </div>
}

<EditForm Model="@registro" OnValidSubmit="@LidarComEnvioValido">
    <DataAnnotationsValidator />

    <ValidationSummary />

    <div class="form-group mb-3">
        <label for="dataHora">Data e Hora:</label>
        <InputDate id="dataHora" class="form-control" @bind-Value="registro.DataRegistro" />
        <ValidationMessage For="@(() => registro.DataRegistro)" />
    </div>

    <div class="form-group mb-3">
        <label for="emocao">Emoção Principal:</label>
        <InputText id="emocao" class="form-control" @bind-Value="registro.EmocaoPrincipal" />
        <ValidationMessage For="@(() => registro.EmocaoPrincipal)" />
    </div>

    <div class="form-group mb-3">
        <label for="intensidade">Nível de Intensidade (1 a 10):</label>
        <InputNumber id="intensidade" class="form-control" @bind-Value="registro.NivelIntensidade" />
        <ValidationMessage For="@(() => registro.NivelIntensidade)" />
    </div>

    <div class="form-group mb-3">
        <label for="gatilho">Gatilho/Causa:</label>
        <InputTextArea id="gatilho" class="form-control" @bind-Value="registro.DescricaoGatilho" rows="3" />
        <ValidationMessage For="@(() => registro.DescricaoGatilho)" />
    </div>

    <div class="form-group mb-4">
        <label for="notas">Notas Adicionais:</label>
        <InputTextArea id="notas" class="form-control" @bind-Value="registro.NotasAdicionais" rows="2" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
        @if (isSubmitting)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <p>Salvando...</p>
        }
        else
        {
            <span>Salvar Registro</span>
        }
    </button>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

</EditForm>

@inject RegistroDiarioService DiarioService
@inject NavigationManager NavManager

@code {
    
    private RegistroDiarioViewModel registro = new RegistroDiarioViewModel();
    private bool isSubmitting = false;
    private bool mostrarSucesso = false;
    private string? errorMessage = null;

    protected override void OnInitialized()
    {
       
        registro.DataRegistro = DateTime.Now;
    }

    private async Task LidarComEnvioValido()
    {
        isSubmitting = true;
        errorMessage = null;
        mostrarSucesso = false;
    
        registro.DataRegistro = registro.DataRegistro.AddTicks(-(registro.DataRegistro.Ticks % TimeSpan.TicksPerSecond));
       
        var sucesso = await AdicionarRegistroAsync(registro);

        if (sucesso)
        {
            mostrarSucesso = true;
           
            registro = new RegistroDiarioViewModel { DataRegistro = DateTime.Now };
        }
        else
        {
            errorMessage = "Falha ao salvar o registro. Verifique a conexão com a API.";
        }

        isSubmitting = false;
    }

    private async Task<bool> AdicionarRegistroAsync(RegistroDiarioViewModel registro)
    {        
        var response = await DiarioService.AdicionarRegistroAPIAsync(registro);
        return response.IsSuccessStatusCode;
    }

    private void RedirecionarParaEstatisticas()
    {
        NavManager.NavigateTo("/estatisticas");
    }

}
